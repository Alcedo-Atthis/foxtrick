<html>
  <script type="text/javascript" src="jkl-parsexml.js"></script>
  <script>
 	 
try{
	
	var newstart = true;
	var mail_count = 0;
	var forum_count = 0;
	var unreadticker_count = 0;
	
	// get resources	
	listUrl = chrome.extension.getURL("default.pref");
	var prefxhr = new XMLHttpRequest();
	prefxhr.open("GET", listUrl, false);
	prefxhr.send();
	var preftext = prefxhr.responseText;
		
	try{
		var lang = localStorage['extensions.foxtrick.prefs.htLanguage'];	
		if ( typeof(lang) == 'undefined' ) {
			var string_regexp = new RegExp( 'user_pref\\("extensions.foxtrick.prefs.htLanguage","(.+)"\\);', "i" );
			lang =  prefxhr.responseText.match(string_regexp)[1];
		} 
		listUrl = chrome.extension.getURL('locale/'+lang+"/foxtrick.properties");
		var propertiesxhr = new XMLHttpRequest();
		propertiesxhr.open("GET", listUrl, false);
		propertiesxhr.send();	
	}
	catch(e) {alert(e); }	
	
	listUrl = chrome.extension.getURL("foxtrick.properties");
	var properties_defaultxhr = new XMLHttpRequest();
	properties_defaultxhr.open("GET", listUrl, false);
	properties_defaultxhr.send();

	listUrl = chrome.extension.getURL("foxtrick.screenshots");
	var screenshotsxhr = new XMLHttpRequest();
	screenshotsxhr.open("GET", listUrl, false);
	screenshotsxhr.send();

	listUrl = chrome.extension.getURL("htlocales/htlang.xml");
	var htlangxhr = new XMLHttpRequest();
	htlangxhr.open("GET", listUrl, false);
	htlangxhr.send();
	
	listUrl = chrome.extension.getURL("htlocales/htcurrency.xml");
	var htcurrencyxhr = new XMLHttpRequest();
	htcurrencyxhr.open("GET", listUrl, false);
	htcurrencyxhr.send();

	listUrl = chrome.extension.getURL("htlocales/htNTidList.xml");
	var htNTidListxhr = new XMLHttpRequest();
	htNTidListxhr.open("GET", listUrl, false);
	htNTidListxhr.send();

	listUrl = chrome.extension.getURL("htlocales/htversions.xml");
	var htversionsxhr = new XMLHttpRequest();
	htversionsxhr.open("GET", listUrl, false);
	htversionsxhr.send();
	
	listUrl = chrome.extension.getURL("htlocales/htdateformat.xml");
	var htdateformatxhr = new XMLHttpRequest();
	htdateformatxhr.open("GET", listUrl, false);
	htdateformatxhr.send();

	listUrl = chrome.extension.getURL("htlocales/foxtrick_about.xml");
	var aboutxhr = new XMLHttpRequest();
	aboutxhr.open("GET", listUrl, false);
	aboutxhr.send();

	// worlddetails
	var xml = new JKL.ParseXML( "htlocales/worlddetails.xml" );
	var data = xml.parse();
	var League = {};
	var countryid_to_leagueid = {};
	
	// reindex: by leagueid and countryid
	for (var i=0; i<data.HattrickData.LeagueList.League.length; i++) {
		League[data.HattrickData.LeagueList.League[i].LeagueID] = data.HattrickData.LeagueList.League[i];
		countryid_to_leagueid[data.HattrickData.LeagueList.League[i].Country.CountryID] = data.HattrickData.LeagueList.League[i].LeagueID;
	}

} catch(e) {alert('resource init:' +e)}
 
// send resource to content scripts 
chrome.extension.onConnect.addListener(function(port) { 
	port.onMessage.addListener(function(msg) {  
	  try {   
		if (msg.reqtype == "pref") { //alert(preftext);
			port.postMessage({pref: preftext});
        } 
	    else if (msg.reqtype == "pref_default") { //alert(preftext);
			port.postMessage({pref_default: prefxhr.responseText});
        } 
	    else if (msg.reqtype == "set_pref") {
			preftext = msg.prefs + preftext;  //alert(preftext.substr(0,120);
			port.postMessage({pref_changed: 'true'});
		} 
		else if (msg.reqtype == "properties") {
           if (propertiesxhr.responseText) port.postMessage({properties: propertiesxhr.responseText});
		   else port.postMessage({properties: ''});
        }
		else if (msg.reqtype == "properties_default") {
           port.postMessage({properties_default: properties_defaultxhr.responseText});
        }
		else if (msg.reqtype == "screenshots") {
           port.postMessage({screenshots: screenshotsxhr.responseText});
        }
		else if (msg.reqtype == "htlang") {  
			port.postMessage({htlang: htlangxhr.responseText});
        }
		else if (msg.reqtype == "htcurrency") {  
			port.postMessage({htcurrency: htcurrencyxhr.responseText});
        }
		else if (msg.reqtype == "htNTidList") {  
			port.postMessage({htNTidList: htNTidListxhr.responseText});
        }
		else if (msg.reqtype == "htversions") {  
			port.postMessage({htversions: htversionsxhr.responseText});
        }
		else if (msg.reqtype == "htdateformat") {  
			port.postMessage({htdateformat: htdateformatxhr.responseText});
        }
		else if (msg.reqtype == "about") {  
			port.postMessage({about: aboutxhr.responseText});
        }
		else if (msg.reqtype == "League") {  
			port.postMessage({League: League});
        }
		else if (msg.reqtype == "countryid_to_leagueid") {  
			port.postMessage({countryid_to_leagueid: countryid_to_leagueid});
        }
		else if (msg.reqtype == "get_old_alerts") {  
			if (newstart) port.postMessage({response:'resetalert'});
			else port.postMessage({response:'noresetalert'});
			newstart = false;
        }
		else if (msg.reqtype == "set_mail_count") {  
			mail_count = msg.mail_count;
			getInboxCount(function(count) {
					updateUnreadCount(String(parseInt(mail_count)+parseInt(forum_count))+'/'+String(unreadticker_count));
			});
		}
		else if (msg.reqtype == "set_forum_count") {  
			forum_count = msg.forum_count;
			getInboxCount(function(count) {
					updateUnreadCount(String(parseInt(mail_count)+parseInt(forum_count))+'/'+String(unreadticker_count));
			});
		}
		else if (msg.reqtype == "set_unreadticker_count") {  
			unreadticker_count = msg.unreadticker_count;
			getInboxCount(function(count) {
					updateUnreadCount(String(parseInt(mail_count)+parseInt(forum_count))+'/'+String(unreadticker_count));
			});
		}
	  } catch(e) {alert('error msg.reqtype : '+msg.reqtype+' '+e);} 
	});
});

// reload strings after lang change
chrome.extension.onConnect.addListener(function(port) {
  if (port.name == "setpref") {
	port.onMessage.addListener(function(msg) {
		localStorage[msg.pref] = msg.value;	
		if (msg.pref=="extensions.foxtrick.prefs.htLanguage") {
			listUrl = chrome.extension.getURL('locale/'+msg.value+"/foxtrick.properties");
			propertiesxhr.open("GET", listUrl, false);
			propertiesxhr.send();	 
			port.postMessage({properties: propertiesxhr.responseText, from: msg.from});	
		}		
	});
  }
});



// ################## notification ##################
var animationFrames = 36;
var animationSpeed = 10; // ms
var canvas;
var canvasContext;
var loggedInImage;
var pollIntervalMin = 1000 * 60;  // 1 minute
var pollIntervalMax = 1000 * 60 * 60;  // 1 hour
var requestFailureCount = 0;  // used for exponential backoff
var requestTimeout = 1000 * 2;  // 5 seconds
var rotation = 0;
var unreadCount = '0/0';
var loadingAnimation = new LoadingAnimation();

function getGmailUrl() {
  var url = "hattrick.org";
  if (localStorage.customDomain)
    url += localStorage.customDomain + "/";
  else
    url += ""
  return url;
}

function getFeedUrl() {
  return getGmailUrl() + "feed/atom";
}

function isGmailUrl(url) {
  // This is the Gmail we're looking for if:
  // - starts with the correct gmail url
  // - doesn't contain any other path chars
  var gmail = getGmailUrl();
  if (url.indexOf(gmail) == -1)
    return false;

  return true; //url.length == gmail.length || url[gmail.length] == '?' || url[gmail.length] == '#';
}

// A "loading" animation displayed while we wait for the first response from
// Gmail. This animates the badge text with a dot that cycles from left to
// right.
function LoadingAnimation() {
  this.timerId_ = 0;
  this.maxCount_ = 8;  // Total number of states in animation
  this.current_ = 0;  // Current state
  this.maxDot_ = 4;  // Max number of dots in animation
}

LoadingAnimation.prototype.paintFrame = function() { return;
  var text = "";
  for (var i = 0; i < this.maxDot_; i++) {
    text += (i == this.current_) ? "." : " ";
  }
  if (this.current_ >= this.maxDot_)
    text += "";

  chrome.browserAction.setBadgeText({text:text});
  this.current_++;
  if (this.current_ == this.maxCount_)
    this.current_ = 0;
}

LoadingAnimation.prototype.start = function() {
  if (this.timerId_)
    return;

  var self = this;
  this.timerId_ = window.setInterval(function() {
    self.paintFrame();
  }, 100);
}

LoadingAnimation.prototype.stop = function() {
  if (!this.timerId_)
    return;

  window.clearInterval(this.timerId_);
  this.timerId_ = 0;
}


chrome.tabs.onUpdated.addListener(function(tabId, changeInfo) {
  if (changeInfo.url && isGmailUrl(changeInfo.url)) {
    getInboxCount(function(count) {
      updateUnreadCount(count);
    });
  }
});


function init() {
  canvas = document.getElementById('canvas');
  loggedInImage = document.getElementById('logged_in');
  canvasContext = canvas.getContext('2d');

  chrome.browserAction.setBadgeBackgroundColor({color:[208, 0, 24, 255]});
  chrome.browserAction.setIcon({path: "gmail_logged_in.png"});
  loadingAnimation.start();

  startRequest();
}

function scheduleRequest() {
  var randomness = Math.random() * 2;
  var exponent = Math.pow(2, requestFailureCount);
  var delay = Math.min(randomness * pollIntervalMin * exponent,
                       pollIntervalMax);
  delay = Math.round(delay);

  window.setTimeout(startRequest, delay);
}

// ajax stuff
function startRequest() {
  getInboxCount(
    function(count) { //mail_count+forum_count+unreadticker_count
      loadingAnimation.stop();
      updateUnreadCount(String(parseInt(mail_count)+parseInt(forum_count))+'/'+String(unreadticker_count));
      scheduleRequest();
    },
    function() {
      loadingAnimation.stop();
      showLoggedOut();
      scheduleRequest();
    }
  );
}

function getInboxCount(onSuccess, onError) { 
//alert('getInboxCount '+ mail_count);
  function handleSuccess(count) { //alert('getInboxCount '+ count);
    requestFailureCount = 0;
    if (onSuccess)
      onSuccess(count);
  }

  function handleError() {
    ++requestFailureCount;
    if (onError)
      onError();
  }

  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && isGmailUrl(tab.url)) { 
			if (tab.url.search(/.+.hattrick.org\/$/)==-1) handleSuccess(mail_count);
			return;
      }
    }
  });
  //alert('handleError');
  handleError();
}

function updateUnreadCount(count) {
  if (unreadCount != count) { //alert(unreadCount +' '+ count+' '+(unreadCount != count));
    unreadCount = count;
    animateFlip();
  }
}


function ease(x) {
  return (1-Math.sin(Math.PI/2+x*Math.PI))/2;
}

function animateFlip() {
  rotation += 1/animationFrames;
  drawIconAtRotation();

  if (rotation <= 1) {
    setTimeout("animateFlip()", animationSpeed);
  } else {
	rotation = 0;
    drawIconAtRotation(); 
    chrome.browserAction.setBadgeText({ 
      text: unreadCount=='0/0'?'':unreadCount
    });
    chrome.browserAction.setBadgeBackgroundColor({color:[208, 0, 24, 255]});
  }
}

function showLoggedOut() {  //alert('showLoggedOut'); 
  unreadCount = '0/0';
  chrome.browserAction.setIcon({path:"gmail_not_logged_in.png"});
  chrome.browserAction.setBadgeBackgroundColor({color:[190, 190, 190, 230]});
  chrome.browserAction.setBadgeText({text:"?"});
}

function drawIconAtRotation() {
  canvasContext.save();
  canvasContext.clearRect(0, 0, canvas.width, canvas.height);
  canvasContext.translate(
      Math.ceil(canvas.width/2),
      Math.ceil(canvas.height/2));
  canvasContext.rotate(2*Math.PI*ease(rotation));
  canvasContext.drawImage(loggedInImage,
      -Math.ceil(canvas.width/2),
      -Math.ceil(canvas.height/2));
  canvasContext.restore();

  chrome.browserAction.setIcon({imageData:canvasContext.getImageData(0, 0,
      canvas.width,canvas.height)});
}

function goToInbox() {
  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && isGmailUrl(tab.url)) {
		chrome.tabs.update(tab.id, {selected: true});
        return;
      }
    }
    chrome.tabs.create({url: getGmailUrl()});
  });
}

// Called when the user clicks on the browser action.
chrome.browserAction.onClicked.addListener(function(tab) {
  goToInbox();
});

</script>
</head>
<body onload="init()">
<img id="logged_in" src="gmail_logged_in.png">
<canvas id="canvas" width="19" height="19">
</body>
</html>

