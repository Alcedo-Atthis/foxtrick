<html>
  <script type="text/javascript" src="jkl-parsexml.js"></script>
  <script>
 	 
try{
	// get resources	

	if ( typeof(localStorage['pref']) == 'undefined' ) {			
		// default prefs
		listUrl = chrome.extension.getURL("default.pref");
		var prefxhr = new XMLHttpRequest();
		prefxhr.open("GET", listUrl, false);
		prefxhr.send();
		var preftext = prefxhr.responseText;
	}
	else var preftext =  localStorage['pref'];  // saved prefs

	listUrl = chrome.extension.getURL("default.pref");
	var prefdefaultxhr = new XMLHttpRequest();
	prefdefaultxhr.open("GET", listUrl, false);
	prefdefaultxhr.send();
	
		
	try {
		var propertiesxhr = new XMLHttpRequest();
		//var lang = localStorage['extensions.foxtrick.prefs.htLanguage'];	
		if ( typeof(lang) == 'undefined' ) {
			var string_regexp = new RegExp( 'user_pref\\("extensions.foxtrick.prefs.htLanguage","(.+)"\\);', "i" );
			lang =  preftext.match(string_regexp)[1];
		} 
		listUrl = chrome.extension.getURL('locale/'+lang+"/foxtrick.properties");
		propertiesxhr.open("GET", listUrl, false);
		propertiesxhr.send();	
	}
	catch(e) {alert(e); }	
	
	listUrl = chrome.extension.getURL("foxtrick.properties");
	var properties_defaultxhr = new XMLHttpRequest();
	properties_defaultxhr.open("GET", listUrl, false);
	properties_defaultxhr.send();

	listUrl = chrome.extension.getURL("foxtrick.screenshots");
	var screenshotsxhr = new XMLHttpRequest();
	screenshotsxhr.open("GET", listUrl, false);
	screenshotsxhr.send();

	listUrl = chrome.extension.getURL("htlocales/htlang.xml");
	var htlangxhr = new XMLHttpRequest();
	htlangxhr.open("GET", listUrl, false);
	htlangxhr.send();
	
	listUrl = chrome.extension.getURL("htlocales/htcurrency.xml");
	var htcurrencyxhr = new XMLHttpRequest();
	htcurrencyxhr.open("GET", listUrl, false);
	htcurrencyxhr.send();

	listUrl = chrome.extension.getURL("htlocales/htNTidList.xml");
	var htNTidListxhr = new XMLHttpRequest();
	htNTidListxhr.open("GET", listUrl, false);
	htNTidListxhr.send();

	listUrl = chrome.extension.getURL("htlocales/htversions.xml");
	var htversionsxhr = new XMLHttpRequest();
	htversionsxhr.open("GET", listUrl, false);
	htversionsxhr.send();
	
	listUrl = chrome.extension.getURL("htlocales/htdateformat.xml");
	var htdateformatxhr = new XMLHttpRequest();
	htdateformatxhr.open("GET", listUrl, false);
	htdateformatxhr.send();

	listUrl = chrome.extension.getURL("htlocales/foxtrick_about.xml");
	var aboutxhr = new XMLHttpRequest();
	aboutxhr.open("GET", listUrl, false);
	aboutxhr.send();

	// worlddetails
	var xml = new JKL.ParseXML( "htlocales/worlddetails.xml" );
	var data = xml.parse();
	var League = {};
	var countryid_to_leagueid = {};
	
	// reindex: by leagueid and countryid
	for (var i=0; i<data.HattrickData.LeagueList.League.length; i++) {
		League[data.HattrickData.LeagueList.League[i].LeagueID] = data.HattrickData.LeagueList.League[i];
		countryid_to_leagueid[data.HattrickData.LeagueList.League[i].Country.CountryID] = data.HattrickData.LeagueList.League[i].LeagueID;
	}

} catch(e) {alert('resource init:' +e)}
 
// send resource to content scripts 
chrome.extension.onConnect.addListener(function(port) { 
	port.onMessage.addListener(function(msg) {  
	  try {   
		if (msg.reqtype == "pref") { //alert(preftext);
			port.postMessage({pref: preftext});
        } 
	    else if (msg.reqtype == "pref_default") { //alert(preftext);
			port.postMessage({pref_default: prefdefaultxhr.responseText});
        } 
	    else if (msg.reqtype == "dump_prefs") {
			// save new properties			
			var lines = msg.prefs.split(/\n+/g);
			for (var i = 0; i< lines.length;++i) {
				var thispref = lines[i].match(/\("(extensions.foxtrick.prefs.+)",(.+)\);/); 
				if (thispref && preftext.search(thispref[1])!=-1) 
				{   // replace exitsting
					var string_regexp = new RegExp('"'+thispref[1]+'",.+\\);');
					preftext = preftext.replace(string_regexp,'"'+ thispref[1]+'",'+thispref[2]+');')
				}
				else {  // add new ones
					preftext += lines[i]+'\n';
				}
			}
			// save in extension settings
			localStorage['pref'] = preftext;
			
			try {  // set new lang
				var string_regexp = new RegExp( 'user_pref\\("extensions.foxtrick.prefs.htLanguage","(.+)"\\);', "i" );
				lang =  preftext.match(string_regexp)[1];
				listUrl = chrome.extension.getURL('locale/'+lang+"/foxtrick.properties");
				propertiesxhr.open("GET", listUrl, false);
				propertiesxhr.send();	 
			} catch(e) {alert('language doesnt exist: '+lang+' '+e);}
			
			port.postMessage({pref_changed: 'true', prefs:preftext, properties: propertiesxhr.responseText});
		} 
		else if (msg.reqtype == "properties") {
           if (propertiesxhr.responseText) port.postMessage({properties: propertiesxhr.responseText});
		   else port.postMessage({properties: ''});
        }
		else if (msg.reqtype == "properties_default") {
           port.postMessage({properties_default: properties_defaultxhr.responseText});
        }
		else if (msg.reqtype == "screenshots") {
           port.postMessage({screenshots: screenshotsxhr.responseText});
        }
		else if (msg.reqtype == "htlang") {  
			port.postMessage({htlang: htlangxhr.responseText});
        }
		else if (msg.reqtype == "htcurrency") {  
			port.postMessage({htcurrency: htcurrencyxhr.responseText});
        }
		else if (msg.reqtype == "htNTidList") {  
			port.postMessage({htNTidList: htNTidListxhr.responseText});
        }
		else if (msg.reqtype == "htversions") {  
			port.postMessage({htversions: htversionsxhr.responseText});
        }
		else if (msg.reqtype == "htdateformat") {  
			port.postMessage({htdateformat: htdateformatxhr.responseText});
        }
		else if (msg.reqtype == "about") {  
			port.postMessage({about: aboutxhr.responseText});
        }
		else if (msg.reqtype == "League") {  
			port.postMessage({League: League});
        }
		else if (msg.reqtype == "countryid_to_leagueid") {  
			port.postMessage({countryid_to_leagueid: countryid_to_leagueid});
        }
		else if (msg.reqtype == "get_old_alerts") {  
			if (newstart) port.postMessage({response:'resetalert'});
			else port.postMessage({response:'noresetalert'});
			newstart = false;
        }
		else if (msg.reqtype == "set_mail_count") {  
			mail_count = msg.mail_count;
			getInboxCount(function(count) {
					updateUnreadCount(String(parseInt(mail_count)+parseInt(forum_count))+'/'+String(unreadticker_count));
			});
		}
		else if (msg.reqtype == "set_forum_count") {  
			forum_count = msg.forum_count;
			getInboxCount(function(count) {
					updateUnreadCount(String(parseInt(mail_count)+parseInt(forum_count))+'/'+String(unreadticker_count));
			});
		}
		else if (msg.reqtype == "set_unreadticker_count") {  
			unreadticker_count = msg.unreadticker_count;
			getInboxCount(function(count) {
					updateUnreadCount(String(parseInt(mail_count)+parseInt(forum_count))+'/'+String(unreadticker_count));
			});
		}
	  } catch(e) {alert('error msg.reqtype : '+msg.reqtype+' '+e);} 
	});
});

// reload strings after lang change
chrome.extension.onConnect.addListener(function(port) {
  if (port.name == "setpref") {
	port.onMessage.addListener(function(msg) {
		localStorage[msg.pref] = msg.value;	
		if (msg.pref=="extensions.foxtrick.prefs.htLanguage") {
			listUrl = chrome.extension.getURL('locale/'+msg.value+"/foxtrick.properties");
			propertiesxhr.open("GET", listUrl, false);
			propertiesxhr.send();	 
			port.postMessage({properties: propertiesxhr.responseText, from: msg.from});	
		}
	});
  }
});

</script>
  <script type="text/javascript" src=" background_ticker.js"></script>
</head>
<body onload="background_ticker_init()">
<img id="logged_in" src="resources/img/foxtrick18grey.png">
<canvas id="canvas" width="18" height="18">
</body>
</html>

