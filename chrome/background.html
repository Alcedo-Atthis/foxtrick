<html>
  <script type="text/javascript" src="jkl-parsexml.js"></script>
  <script>
 	 
try{  

//alert('load background')


var resources_changed = true;


function isHTUrl(url) {
  if (url.search(/hattrick.org|hattrick.ws|hattrick.interia.ws/) == -1) return false;
  return true; 
}


	// get resources	
	
	// get prefrences
	// if prefs not set in extension settings, get default values
	if ( typeof(localStorage['pref']) == 'undefined'  || localStorage['pref']=='') {			
		// default prefs
		listUrl = chrome.extension.getURL("default.pref");
		var prefxhr = new XMLHttpRequest();
		prefxhr.open("GET", listUrl, false);
		prefxhr.send();
		var preftext = prefxhr.responseText;
	}
	else var preftext =  localStorage['pref'];  // save prefs in extension settings

	listUrl = chrome.extension.getURL("default.pref");
	var prefdefaultxhr = new XMLHttpRequest();
	prefdefaultxhr.open("GET", listUrl, false);
	prefdefaultxhr.send();
		
	// get strings	
	listUrl = chrome.extension.getURL("foxtrick.properties");
	var properties_defaultxhr = new XMLHttpRequest();
	properties_defaultxhr.open("GET", listUrl, false);
	properties_defaultxhr.send();

	var session_lang ='en';
	try {
		var propertiesxhr = new XMLHttpRequest();
		var string_regexp = new RegExp( 'user_pref\\("extensions.foxtrick.prefs.htLanguage","(.+)"\\);', "i" );
		session_lang =  preftext.match(string_regexp)[1];
		listUrl = chrome.extension.getURL('locale/'+session_lang+"/foxtrick.properties");
		propertiesxhr.open("GET", listUrl, false);
		propertiesxhr.send();	
		var properties = propertiesxhr.responseText;
	}
	catch(e) {
			var properties = properties_defaultxhr.responseText;
	}	
	
	// get other non changeable ersources
	listUrl = chrome.extension.getURL("foxtrick.screenshots");
	var screenshotsxhr = new XMLHttpRequest();
	screenshotsxhr.open("GET", listUrl, false);
	screenshotsxhr.send();

	listUrl = chrome.extension.getURL("htlocales/htlang.xml");
	var htlangxhr = new XMLHttpRequest();
	htlangxhr.open("GET", listUrl, false);
	htlangxhr.send();
	
	listUrl = chrome.extension.getURL("htlocales/htcurrency.xml");
	var htcurrencyxhr = new XMLHttpRequest();
	htcurrencyxhr.open("GET", listUrl, false);
	htcurrencyxhr.send();

	listUrl = chrome.extension.getURL("htlocales/htNTidList.xml");
	var htNTidListxhr = new XMLHttpRequest();
	htNTidListxhr.open("GET", listUrl, false);
	htNTidListxhr.send();

	listUrl = chrome.extension.getURL("htlocales/htversions.xml");
	var htversionsxhr = new XMLHttpRequest();
	htversionsxhr.open("GET", listUrl, false);
	htversionsxhr.send();
	
	listUrl = chrome.extension.getURL("htlocales/htdateformat.xml");
	var htdateformatxhr = new XMLHttpRequest();
	htdateformatxhr.open("GET", listUrl, false);
	htdateformatxhr.send();

	listUrl = chrome.extension.getURL("htlocales/foxtrick_about.xml");
	var aboutxhr = new XMLHttpRequest();
	aboutxhr.open("GET", listUrl, false);
	aboutxhr.send();

	// worlddetails
	var xml = new JKL.ParseXML( "htlocales/worlddetails.xml" );
	var data = xml.parse();// alert(data.HattrickData.LeagueList.League.length);
	var League = {};
	var countryid_to_leagueid = {};
	
	// reindex: by leagueid and countryid
	for (var i=0; i<data.HattrickData.LeagueList.League.length; i++) {
		League[data.HattrickData.LeagueList.League[i].LeagueID] = data.HattrickData.LeagueList.League[i];
		countryid_to_leagueid[data.HattrickData.LeagueList.League[i].Country.CountryID] = data.HattrickData.LeagueList.League[i].LeagueID;
	}

	var hty_staff = new Array();
	var req = new XMLHttpRequest();
	var abortTimerId = window.setTimeout(function(){req.abort()}, 20000);
	var stopTimer = function(){window.clearTimeout(abortTimerId); };
	req.onreadystatechange = function(){
		if (req.readyState == 4){ 
			stopTimer(); 
			var frag = document.createElement('dummy');
			frag.innerHTML = req.responseText; 
			var htyusers = frag.getElementsByTagName('user');
			for (var i=0;i<htyusers.length;++i) {
				hty_staff.push(htyusers[i].getElementsByTagName('alias')[0].innerHTML);
			}
		}
	}
	var url = 'http://www.hattrick-youthclub.org/_admin/foxtrick/team.xml';
	req.open('GET', url , true); 
	req.send(null);
	
} catch(e) {alert('resource init:' +e)}


	/*try{
		var matchid = FoxtrickHelper.getMatchIdFromUrl(doc.location.href); 
		var isarchivedmatch = (doc.getElementById("ctl00_CPMain_lblMatchInfo")==null);
		var isprematch = (doc.getElementById("ctl00_CPMain_pnlPreMatch")!=null);
		if (isprematch) return;
		
		if (isarchivedmatch && typeof(this.matchxmls[matchid]) == 'undefined') {
			var req = new XMLHttpRequest();
			req.open('GET', 'http://'+doc.location.hostname+'/Community/CHPP/Matches/chppxml.axd?file=matchdetails&matchID='+matchid+'&matchEvents=true', false); 
			req.send(null);
			if (req.status == 200) {
				this.matchxmls[matchid] = req.responseXML;
				dump('matches.js: get new xml\n');
			}
			else Foxtrick.dump('matches.js: xml request failed\n');
		}
	} catch(e){Foxtrick.dump('matches.js run: '+e+'\n');}*/

 
//alert('back');

// send resource to content scripts 
chrome.extension.onConnect.addListener(function(port) { 
	if (port.name == "ftpref-query") 
	{ //alert('ftpref: '+port.name);
	 port.onMessage.addListener(function(msg) {  
	  try {  //alert(msg.reqtype);
		if (msg.reqtype == "get_settings") {   //alert("get_settings " + msg.reqtype);
			//alert('send settings');
			port.postMessage({
				set:'settings', 
				pref: preftext,
				pref_default: prefdefaultxhr.responseText,
				properties: properties,
				properties_default: properties_defaultxhr.responseText,
				screenshots: screenshotsxhr.responseText,
				htlang: htlangxhr.responseText,
				htcurrency: htcurrencyxhr.responseText,
				htNTidList: htNTidListxhr.responseText,
				htversions: htversionsxhr.responseText,
				htdateformat: htdateformatxhr.responseText,
				about: aboutxhr.responseText,
				League: League,
				countryid_to_leagueid: countryid_to_leagueid,
				});			
        }
		else if (msg.reqtype == "get_hty_staff") {// alert("get_hty_staff " + msg.reqtype);
			//alert('send hty_staff');
			port.postMessage({
				set:'hty_staff',
				hty_staff: hty_staff, 
			});
        }
		else if (msg.reqtype == "get_css_text") {
		  try  {
			var css_text_from_response='';
			var cssUrl = msg.css_filelist.split('\n');
			for (var i=0; i<cssUrl.length; ++i) { 
				var css_text='';
				if (cssUrl[i].search(/^http|^chrome-extension/)!=-1) { //is a resource file. get cssfile content 
					css_xhr = new XMLHttpRequest();
					css_xhr.open("GET", cssUrl[i], false);
					css_xhr.send();
					css_text = css_xhr.responseText;
				}
				else {  css_text = cssUrl[i]; // not a file but line is css text
				}
				if (css_text) {  // remove moz-document statement
					if ( css_text.search('@-moz-document')!=-1) {
						css_text = css_text.replace(/@-moz-document[^\{]+\{/,''); 
						var closing_bracket = css_text.lastIndexOf('}');
						css_text = css_text.substr(0,closing_bracket)+css_text.substr(closing_bracket+1);
					}					
				}
				css_text_from_response += css_text;
			}
			// replace ff chrome reference by google chrome refs
			var exturl = chrome.extension.getURL('');
			css_text_from_response = css_text_from_response.replace(/chrome:\/\/foxtrick\/content\//g, exturl);
			
			//var newwin = window.open("","");
			//newwin.document.write('<!DOCTYPE html><html><head><title>Export preferences</title></head><body>'+css_text_from_response.replace(/\n/gi,'<br>')+'</body></html>');			
		
            port.postMessage({set:'css_text_set', css_text: css_text_from_response});
		  } catch(e) {alert('css xhr '+e);alert(cssUrl[i])}
        }
	    else if (msg.reqtype == "export_prefs") {
			var newwin = window.open("about:blank","FoxTrick Preferences","menubar=yes,location=no,resizable=yes,width=400,height=400");
			newwin.document.write('<!DOCTYPE html><html><head><title>Export preferences</title></head><body>// Copy content to a text file and save it<br>'+msg.prefs.replace(/\n/gi,'<br>')+'</body></html>');			
			newwin.focus();		
		}
	    else if (msg.reqtype == "save_prefs") {
			// save new session properties			
			preftext = msg.prefs;
			// save in extension settings
			localStorage['pref'] = preftext; 
			
			try {  // set new lang
				var string_regexp = new RegExp( 'user_pref\\("extensions.foxtrick.prefs.htLanguage","(.+)"\\);', "i" );
				try{ var lang =  preftext.match(string_regexp)[1];
				}catch(e) { var lang =  prefdefaultxhr.responseText.match(string_regexp)[1];}
				if (lang != session_lang || msg.reload==true) {
					listUrl = chrome.extension.getURL('locale/'+lang+"/foxtrick.properties");
					propertiesxhr.open("GET", listUrl, false);
					propertiesxhr.send();
					properties = propertiesxhr.responseText;					
					localStorage['properties']=properties;
					port.postMessage({set:'lang_changed', properties: propertiesxhr.responseText, reload:msg.reload});
				}
			} catch(e) {alert('language doesnt exist: '+lang+' '+e);}			
		} 
	    else if (msg.reqtype == "delete_pref") {
			// delete a preference			
			try {
			var string_regexp = new RegExp( 'user_pref\\("'+msg.pref+'".+\\n','g');
			console.log(string_regexp+' '+preftext.search(string_regexp));
			preftext = preftext.replace(string_regexp,'');
			localStorage['pref'] = preftext;
			} catch(e) {alert('delete_pref '+e);}
			//port.postMessage({pref_changed: 'true', prefs:preftext, properties: properties, reload:false});
		} 
	    else if (msg.reqtype == "delete_pref_list") {
			// delete a preference			
			try {
			var string_regexp = new RegExp( 'user_pref\\("'+msg.pref+'".+\\n','g');
			alert(string_regexp+' '+preftext.search(string_regexp));
			preftext = preftext.replace(string_regexp,'');
			localStorage['pref'] = preftext;
			} catch(e) {alert('delete_pref '+e);}
			port.postMessage({pref_changed: 'true', prefs:preftext, properties: properties, reload:false});
		} 
	  } catch(e) {alert('error msg.reqtype : '+msg.reqtype+' '+e);} 
	 });	
	}
	if (port.name == "alert") 
	{ //alert('ftpref: '+port.name);
	port.onMessage.addListener(function(msg) {  
	  try { 	
		if (msg.reqtype == "get_old_alerts") {  
			if (newstart) port.postMessage({response:'resetalert'});
			else port.postMessage({response:'noresetalert'});
			newstart = false;
        }
		else if (msg.reqtype == "set_mail_count") {  
			mail_count = msg.mail_count;
			getInboxCount(function(count) { //alert(mail_count);
					updateUnreadCount(String(parseInt(mail_count)+parseInt(forum_count))+'/'+String(unreadticker_count));
			});
		}
		else if (msg.reqtype == "set_forum_count") {  
			forum_count = msg.forum_count;
			getInboxCount(function(count) {
					updateUnreadCount(String(parseInt(mail_count)+parseInt(forum_count))+'/'+String(unreadticker_count));
			});
		}
		else if (msg.reqtype == "set_unreadticker_count") {  
			unreadticker_count = msg.unreadticker_count;
			getInboxCount(function(count) {
					updateUnreadCount(String(parseInt(mail_count)+parseInt(forum_count))+'/'+String(unreadticker_count));
			});
		}
		 else port.postMessage({});				    
	  } catch(e) {alert('error msg.reqtype : '+msg.reqtype+' '+e);} 
	 });	
	}
	if (port.name == "chatoldserver") 
	{ 
	port.onMessage.addListener(function(msg) {  
		if (msg.reqtype == "set_last_server") {  
			localStorage['lastserver'] = msg.lastserver;
        }
		else if (msg.reqtype == "get_last_server") {  
			port.postMessage({response:'lastserver',lastserver:localStorage['lastserver']});
        }
		})
	}
		/*if (port.name == "htms") { //alert('htms: '+port.name);
		port.onMessage.addListener(function(msg) {  
		  if (msg.reqtype=="get_htms") { 	
			var req = new XMLHttpRequest();
			var abortTimerId = window.setTimeout(function(){req.abort()}, 20000);
			var stopTimer = function(){window.clearTimeout(abortTimerId); };
			req.onreadystatechange = function(){ 
				if (req.readyState == 4){ 
					stopTimer(); 
					port.postMessage({set:'htms', responseText: req.responseText});	
				}
			}
			req.open('GET', msg.url , true); 
			req.send(null);
		  }
	    });
	}*/
});


chrome.extension.onConnect.addListener(function(port2) {
	if (port2.name == "htms") { //alert('htms: '+port.name);
		port2.onMessage.addListener(function(msg) {  
		  if (msg.reqtype=="get_htms") { 
			//port2.postMessage({set:'htms', responseText: 'ff'});	
						  
			var req = new XMLHttpRequest();
			var abortTimerId = window.setTimeout(function(){req.abort()}, 20000);
			var stopTimer = function(){window.clearTimeout(abortTimerId); };
			req.onreadystatechange = function(){ 
				if (req.readyState == 4){ 
					stopTimer(); 
					port2.postMessage({set:'htms', responseText: req.responseText});	
				}
			}
			req.open('GET', msg.url , true); 
			req.send(null);
		  }
		  else port2.postMessage({});			
	    });
	}
});


// reload strings after lang change
chrome.extension.onConnect.addListener(function(port) {
  if (port.name == "setpref") {
	port.onMessage.addListener(function(msg) {
		localStorage[msg.pref] = msg.value;	
		if (msg.pref=="extensions.foxtrick.prefs.htLanguage") {
			listUrl = chrome.extension.getURL('locale/'+msg.value+"/foxtrick.properties");
			propertiesxhr.open("GET", listUrl, false);
			propertiesxhr.send();
			properties = propertiesxhr.responseText;
			port.postMessage({set:"setlang", properties: propertiesxhr.responseText, from: msg.from});	
		}
	});
  }
});

</script>
  <script type="text/javascript" src=" background_ticker.js"></script>
</head>
<body onload="background_ticker_init()">
<img id="logged_in" src="resources/img/foxtrick18grey.png">
<canvas id="canvas" width="18" height="18">
</body>
</html>
